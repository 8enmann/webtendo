<!DOCTYPE html>
<html>

  <head>

    <title>Webtendo</title>

    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/client.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  </head>
  <body>
    <div class="ctrl-left touch-region" data-buttonvalue="stick">
      <div id="joystick">
	<div id="stick"></div>
      </div>
    </div>
    <div id="buttonBox">
      <button data-buttonvalue="a" class="a touch-region">A</button>
      <button data-buttonvalue="b" class="b touch-region">B</button>
    </div>
    <div id="latency">Connecting...</div>
    <img id="fullscreen" class="fullscreen" src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjEyOHB4IiBoZWlnaHQ9IjEyOHB4Ij4KPGc+Cgk8Zz4KCQk8cGF0aCBkPSJNMCwwdjUxMmg1MTJWMEgweiBNMTk1LjA0OCw0MjAuNTcxdjM2LjU3MUg1NC44NTd2LTE0MC4xOWgzNi41NzF2NzcuNzYybDEwMi44OC0xMDIuODhsMjUuODYsMjUuODZMMTE3LjI5MSw0MjAuNTcxICAgIEgxOTUuMDQ4eiBNMTk0LjMwOSwyMjAuMTdMOTEuNDI5LDExNy4yOTF2NzcuNzU3SDU0Ljg1N1Y1NC44NTdoMTQwLjE5djM2LjU3MWgtNzcuNzYyTDIyMC4xNjksMTk0LjMxTDE5NC4zMDksMjIwLjE3eiAgICAgTTQ1Ny4xNDMsNDU3LjE0M2gtMTQwLjE5di0zNi41NzFoNzcuNzU3bC0xMDIuODc4LTEwMi44OGwyNS44Ni0yNS44NmwxMDIuODgsMTAyLjg4M3YtNzcuNzYyaDM2LjU3MVY0NTcuMTQzeiBNNDU3LjE0MywxOTUuMDQ4ICAgIGgtMzYuNTcxdi03Ny43NTdsLTEwMi44OCwxMDIuODhsLTI1Ljg2LTI1Ljg2TDM5NC43MTQsOTEuNDI5aC03Ny43NjJWNTQuODU3aDE0MC4xOVYxOTUuMDQ4eiIgZmlsbD0iIzAwMDAwMCIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="scripts/webrtc-adapter/out/adapter.js"></script>
    <script src="js/main.js"></script>
    <script src="js/client.js"></script>
    <script>
     onMessageReceived = function(x) {
       // TODO: do something with message from host.
       console.log(x);
     }
     onConnected = function(id) {
       console.log(id, 'connected');
       sendToHost({hello: 'host'});
     }

     // This can only be called in an onclick handler
     // TODO: stick this inside a dedicated button.
     var joystick = document.getElementById('joystick');
     var stick = document.getElementById('stick');
     function moveStick(x,y) {
       let radius = joystick.offsetWidth/2;
       // Check to see if the point is out of bounds and if so, clip.
       let distance = Math.sqrt(Math.pow(x - radius, 2) + Math.pow(y - radius, 2));
       let theta = Math.atan2((y - radius), (x - radius));
       if (distance > (radius - stick.offsetWidth/2)) {
	 stick.style.backgroundColor = 'red';
	 x = (radius - stick.offsetWidth/2) * Math.cos(theta) + radius;
	 y = (radius - stick.offsetWidth/2) * Math.sin(theta) + radius;
       } else {
	 stick.style.backgroundColor = 'white';
       }

       let newLeft = x - stick.offsetWidth / 2;
       let newTop = y - stick.offsetHeight / 2;

       stick.style.left = newLeft + 'px';
       stick.style.top = newTop + 'px';
       return {
	 x: Math.cos(theta),
	 y: - Math.sin(theta),
       };
     }
     function handleJoystickTouch(e) {
       e.preventDefault();
       // console.log(e);
       var touches = e.changedTouches;
       for (var i = 0; i < touches.length; i++) {
	 // Any touches elsewhere while a finger is down on the joystick will
	 // block input on the rest of the screen.
	 let region = getRegion(touches[i].pageX, touches[i].pageY);
	 // In joystick part of screen.
	 if (region === 'stick') {
	   let position = {x: 0, y: 0};
	   if (e.type === 'touchend') {
	     resetStick();
	   } else {
	     position = moveStick(touches[i].pageX - joystick.offsetLeft, touches[i].pageY - joystick.offsetTop);
	   }
	   sendToHost({
	     action: e.type,
	     value: region,
	     position: position,
	   });
	 } else {
	   // In button part of screen. Ignore moves.
	   // TODO: fix highlighting.
	   if (e.type !== 'touchmove') {
	     sendToHost({
	       action: e.type,
	       value: region,
	     });
	   }
	 }
       }
       // return true;
     }
     document.body.addEventListener('touchstart', handleJoystickTouch);
     document.body.addEventListener('touchmove', handleJoystickTouch);
     document.body.addEventListener('touchend', handleJoystickTouch);
     function resetStick() {
       moveStick(joystick.offsetHeight/2, joystick.offsetWidth/2);
     }
     // TODO: call this again on screen orientation change.
     resetStick();
     
    </script>
  </body>
</html>
