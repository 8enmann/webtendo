<!DOCTYPE html>
<html>
  <head>
    <title>Webtendo</title>

    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/client.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
      #latency {
        position: absolute;
        bottom: 0;
        margin: 10px;
        opacity: .5;
      }
      #hand {
        display: block;
        width: 100%;
        flex: 1;
      }
      .ctrl-right {
        height: 100%;
        width:50%;
        display: flex;
        flex-direction: column;
        background-color: #c6e2ff;
      }
      .btn-play {
        padding: 20px;
        border-radius: 5px;
        border: 2px solid black;
        background-color: #4169e1;
      }
      .bottom {
        flex: 1;
        justify-content: center;
        align-items: center;
      }
    </style>

    <script src="/socket.io/socket.io.js"></script>
    <script src="scripts/webrtc-adapter/out/adapter.js"></script>
    <script src="js/joystick.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="//underscorejs.org/underscore-min.js"></script>
    <script src="./js/main.js"></script>
    <script src="./js/client.js"></script>
    <script>
      onMessageReceived = function(x) {
        if (x.hand) {
          drawHand(x.hand);
        }
      }

      function drawHand(hand) {
        $("#hand").empty();
        _.each(hand, function(letter, index) {
          $letter = createLetterDiv(letter, index);
          $("#hand").append($letter);
        });
      }

      function createLetterDiv(letter, index) {
        var id = "letter_" + index;
        var $letter = $("<div />", {
          class: 'letter touch-region',
        });
        $letter.text(letter);
        $letter.attr('id', id);
        $letter.attr('data-buttonvalue', "id=" + id + ",letter=" + letter);
        return $letter;
      }

      function getLetterFromDiv($div) {
        var params = $div.attr('data-buttonvalue').split(',');
        return _.filter(params, function(p) {
          return p.split('=')[0] == 'letter';
        })[0].split('=')[1];
      }

      function selectLetter(id) {
        _.each($("#hand").children(), function(letterDiv) {
          if ($(letterDiv).attr('id') == id) {
            $(letterDiv).addClass('selected');
          } else {
            $(letterDiv).removeClass('selected');
          }
        });
      }

      function playLetter() {
        var $selected = $("#hand .selected");
        if ($selected.length == 0) {
          alert("Please select a letter to play!");
          return;
        }
        var selectedLetterIndex = parseInt($selected.attr('id').slice(-1));
        dataChannels[clientId].send(JSON.stringify({
          letter: getLetterFromDiv($selected),
          index: selectedLetterIndex,
        }));
      }

      function finishTurn() {
        dataChannels[clientId].send(JSON.stringify({
          finish_turn: true,
        }));
      }

     // This can only be called in an onclick handler
     // TODO: stick this inside a dedicated button.
     function moveStick(x,y) {
       var joystick = document.getElementById('joystick');
       var stick = document.getElementById('stick');
       let radius = joystick.offsetWidth/2;
       let relativeX = x - radius;
       let relativeY = y - radius;
       // Check to see if the point is out of bounds and if so, clip.
       let distance = Math.sqrt(Math.pow(relativeX, 2) + Math.pow(relativeY, 2));
       let theta = Math.atan2(relativeY, relativeX);
       let maxDistance = radius - stick.offsetWidth/2;
       if (distance > maxDistance) {
         stick.style.backgroundColor = 'red';
         x = maxDistance * Math.cos(theta) + radius;
         y = maxDistance * Math.sin(theta) + radius;
       } else {
         stick.style.backgroundColor = 'white';
       }
       let newLeft = x - stick.offsetWidth / 2;
       let newTop = y - stick.offsetHeight / 2;

       stick.style.left = newLeft + 'px';
       stick.style.top = newTop + 'px';
       return {
         x: Math.max(-maxDistance, Math.min(maxDistance, relativeX + Math.sign(relativeX) * stick.offsetWidth / 2)) / maxDistance,
         y: Math.max(-maxDistance, Math.min(maxDistance, relativeY + Math.sign(relativeY) * stick.offsetWidth / 2)) / maxDistance,
       };
     }

      function resetStick() {
        var joystick = document.getElementById('joystick');
        var stick = document.getElementById('stick');
        moveStick(joystick.offsetHeight/2, joystick.offsetWidth/2);
      }
 
      onConnected = function(id) {
        console.log(id, 'connected');
        sendToHost({hello: 'host'});
      }
 
      onTouch = function(e, touch, region) {
        console.log(e);
        console.log(region);
        var joystick = document.getElementById('joystick');
        var stick = document.getElementById('stick');
        // In joystick part of screen.
        if (region === 'stick') {
          let position = {x: 0, y: 0};
          if (e.type === 'touchend') {
            resetStick();
          } else {
            position = moveStick(touch.pageX - joystick.offsetLeft, touch.pageY - joystick.offsetTop);
          }
          sendToHost({
            action: e.type,
            value: region,
            position: position,
          });
        } else {
          if (e.type === 'touchmove') {
            // break early
            return;
          }
          console.log(region);
          var params = {};
          _.each(region.split(','), function(a) {
            var b = a.split('=');
            params[b[0]] = b[1];
          });

          if (params["letter"]) {
            selectLetter(params["id"]);
          } else if (params["play_letter"]) {
            if (e.type === 'touchend') {
              // only play on touch end
              playLetter();
            }
          } else if (params["submit"]) {
            finishTurn();
          }
          if (e.type !== 'touchmove') {
            sendToHost({
              action: e.type,
              value: region,
            });
          }
        }
      }

      window.onload = function() {
        init();
        resetStick();
      };

    </script>
  </head>
  <body>
    <img id="fullscreen" class="fullscreen" src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1MTIgNTEyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjEyOHB4IiBoZWlnaHQ9IjEyOHB4Ij4KPGc+Cgk8Zz4KCQk8cGF0aCBkPSJNMCwwdjUxMmg1MTJWMEgweiBNMTk1LjA0OCw0MjAuNTcxdjM2LjU3MUg1NC44NTd2LTE0MC4xOWgzNi41NzF2NzcuNzYybDEwMi44OC0xMDIuODhsMjUuODYsMjUuODZMMTE3LjI5MSw0MjAuNTcxICAgIEgxOTUuMDQ4eiBNMTk0LjMwOSwyMjAuMTdMOTEuNDI5LDExNy4yOTF2NzcuNzU3SDU0Ljg1N1Y1NC44NTdoMTQwLjE5djM2LjU3MWgtNzcuNzYyTDIyMC4xNjksMTk0LjMxTDE5NC4zMDksMjIwLjE3eiAgICAgTTQ1Ny4xNDMsNDU3LjE0M2gtMTQwLjE5di0zNi41NzFoNzcuNzU3bC0xMDIuODc4LTEwMi44OGwyNS44Ni0yNS44NmwxMDIuODgsMTAyLjg4M3YtNzcuNzYyaDM2LjU3MVY0NTcuMTQzeiBNNDU3LjE0MywxOTUuMDQ4ICAgIGgtMzYuNTcxdi03Ny43NTdsLTEwMi44OCwxMDIuODhsLTI1Ljg2LTI1Ljg2TDM5NC43MTQsOTEuNDI5aC03Ny43NjJWNTQuODU3aDE0MC4xOVYxOTUuMDQ4eiIgZmlsbD0iIzAwMDAwMCIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" />

    <div class="ctrl-left touch-region" data-buttonvalue="stick">
      <div id="joystick">
        <div id="stick">
        </div>
      </div>
    </div>

    <div class="ctrl-right">
      <div id="hand">
      </div>
      <div class="bottom">
        <button class="btn-play touch-region" data-buttonvalue='play_letter=true'>Play Letter</button>
        <button class="btn-play touch-region" data-buttonvalue='submit=true'>Finish Turn</button>
      </div>
    </div>
  </body>
</html>
