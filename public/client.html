<!DOCTYPE html>
<html>

  <head>

    <title>Webtendo</title>

    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/client.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
     #latency {
       position: absolute;
       bottom: 0;
       margin: 10px;
       opacity: .5;
     }
    </style>
  </head>
  <body>
    <div class="ctrl-left touch-region" data-buttonvalue="stick">
      <div id="joystick">
	<div id="stick"></div>
      </div>
    </div>
    <div id="buttonBox">
      <button data-buttonvalue="a" class="a touch-region">A</button>
      <button data-buttonvalue="b" class="b touch-region">B</button>
    </div>
    <div id="latency">Connecting...</div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="scripts/webrtc-adapter/out/adapter.js"></script>
    <script src="js/main.js"></script>
    <script>
     // Disable zoom on iOS 10.
     document.addEventListener('gesturestart', function (e) {
       e.preventDefault();
     });

     // This can only be called in an onclick handler
     // TODO: stick this inside a dedicated button.
     var joystick = document.getElementById('joystick');
     var stick = document.getElementById('stick');
     // TODO: replace this with sindresorhus/screenfull.js
     joystick.addEventListener('touchstart', fullscreen);
     function fullscreen(e) {
       document.documentElement.webkitRequestFullScreen();
       joystick.removeEventListener('touchstart', fullscreen);
       if (!screen.orientation.type.includes('landscape')) {
	 screen.orientation.lock('landscape')
	       .then(()=> console.log('switched to landscape'),
		     err => {
		       console.error(err);
		       window.alert('please rotate device');
		     });
       }

     }
     function moveStick(x,y) {
       let radius = joystick.offsetWidth/2;
       // Check to see if the point is out of bounds and if so, clip.
       let distance = Math.sqrt(Math.pow(x - radius, 2) + Math.pow(y - radius, 2));
       let theta = Math.atan2((y - radius), (x - radius));
       if (distance > (radius - stick.offsetWidth/2)) {
	 stick.style.backgroundColor = 'red';
	 x = (radius - stick.offsetWidth/2) * Math.cos(theta) + radius;
	 y = (radius - stick.offsetWidth/2) * Math.sin(theta) + radius;
       } else {
	 stick.style.backgroundColor = 'white';
       }

       let newLeft = x - stick.offsetWidth / 2;
       let newTop = y - stick.offsetHeight / 2;

       stick.style.left = newLeft + 'px';
       stick.style.top = newTop + 'px';
       return {
	 x: Math.cos(theta),
	 y: - Math.sin(theta),
       };
     }
     let regions = document.getElementsByClassName('touch-region');
     function getRegion(x, y) {
       let check = (x, left, width) => x >= left && x <= left + width;
       for (let region of regions) {
	 if (check(x, region.offsetLeft, region.offsetWidth) && check(y, region.offsetTop, region.offsetHeight)) {
	   return region.dataset.buttonvalue;
	 }
       }
     }
     function handleJoystickTouch(e) {
       e.preventDefault();
       // console.log(e);
       var touches = e.changedTouches;
       for (var i = 0; i < touches.length; i++) {
	 // Any touches elsewhere while a finger is down on the joystick will
	 // block input on the rest of the screen.
	 let region = getRegion(touches[i].pageX, touches[i].pageY);
	 // In joystick part of screen.
	 if (region === 'stick') {
	   let position = {x: 0, y: 0};
	   if (e.type === 'touchend') {
	     resetStick();
	   } else {
	     position = moveStick(touches[i].pageX - joystick.offsetLeft, touches[i].pageY - joystick.offsetTop);
	   }
	   dataChannels[clientId].send(JSON.stringify({
	     action: e.type,
	     value: region,
	     position: position,
	   }));
	 } else {
	   // In button part of screen. Ignore moves.
	   // TODO: fix highlighting.
	   if (e.type !== 'touchmove') {
	     dataChannels[clientId].send(JSON.stringify({
	       action: e.type,
	       value: region,
	     }));
	   }
	 }
       }
       // return true;
     }
     document.body.addEventListener('touchstart', handleJoystickTouch);
     document.body.addEventListener('touchmove', handleJoystickTouch);
     document.body.addEventListener('touchend', handleJoystickTouch);
     function resetStick() {
       moveStick(joystick.offsetHeight/2, joystick.offsetWidth/2);
     }
     // TODO: call this again on screen orientation change.
     resetStick();
     
    </script>
  </body>

</html>
